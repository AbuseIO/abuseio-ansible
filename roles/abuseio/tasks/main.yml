---
- name: Create abuseio group
  group:
    name: "{{ abuseio_group }}"
    state: present

- name: Create abuseio user
  user:
    name: "{{ abuseio_user }}"
    group: "{{ abuseio_group }}"
    shell: /bin/false
    create_home: no
    home: "{{ abuseio_home }}"

- name: Check if AbuseIO home exists
  stat:
    path: "{{ abuseio_home }}"
  register: abuseio_home_dir

- name: Clone AbuseIO 5.0
  git:
    repo: "{{ abuseio_repo }}"
    version: "{{ abuseio_git_version }}"
    dest: "{{ abuseio_home }}"
    single_branch: yes
    update: yes
    force: yes
  register: abuseio_git
  when: not (abuseio_home_dir.stat.exists | default(false))

- name: Update AbuseIO repository when home exists
  command: git -C {{ abuseio_home }} pull --ff-only
  when: abuseio_home_dir.stat.exists | default(false)
  become: yes
  become_user: "{{ abuseio_user }}"

- name: Fix ownership recursively when mismatched
  file:
    path: "{{ abuseio_home }}"
    state: directory
    owner: "{{ abuseio_user }}"
    group: "{{ abuseio_group }}"
    recurse: yes
  # enforce ownership unconditionally to avoid safe.directory mismatches

- name: Ensure www-data and postfix are in abuseio group
  user:
    name: "{{ item }}"
    groups: "{{ abuseio_group }}"
    append: yes
  loop:
    - www-data
    - postfix

- name: Install Composer
  shell: |
    set -euo pipefail
    php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
    php composer-setup.php
    php -r "unlink('composer-setup.php');"
    mv composer.phar /usr/bin/composer
  args:
    creates: /usr/bin/composer
    executable: /bin/bash

- name: Run composer install (no dev)
  command: composer install --no-dev --no-interaction
  args:
    chdir: "{{ abuseio_home }}"
  become: yes
  become_user: "{{ abuseio_user }}"

- name: Place .env configuration
  template:
    src: .env.j2
    dest: "{{ abuseio_home }}/.env"
    owner: "{{ abuseio_user }}"
    group: "{{ abuseio_group }}"
    mode: 0640

- name: Generate app key
  command: php artisan key:generate --force
  args:
    chdir: "{{ abuseio_home }}"
  register: appkey_gen
  changed_when: "'Application key set' in appkey_gen.stdout or 'Application key set' in appkey_gen.stderr"
  become_user: "{{ abuseio_user }}"

- name: Run database migrations
  command: php artisan migrate --force
  args:
    chdir: "{{ abuseio_home }}"
  become_user: "{{ abuseio_user }}"

- name: Run database migrations to apply queue table
  command: php artisan migrate --force
  args:
    chdir: "{{ abuseio_home }}"
  become_user: "{{ abuseio_user }}"

- name: Set permissions on storage and bootstrap cache
  file:
    path: "{{ abuseio_home }}/{{ item }}"
    state: directory
    mode: "u=rwX,g=rwX,o="
    recurse: yes
  loop:
    - storage
    - bootstrap/cache

- name: Ensure scheduler cron exists
  cron:
    name: "AbuseIO Laravel scheduler"
    user: "{{ abuseio_user }}"
    minute: "*"
    job: "php {{ abuseio_home }}/artisan schedule:run >> /dev/null 2>&1"

- name: List existing AbuseIO users
  command: php artisan user:list
  args:
    chdir: "{{ abuseio_home }}"
  register: abuseio_user_list
  changed_when: false
  become: yes
  become_user: "{{ abuseio_user }}"

- name: Create AbuseIO admin user if missing
  command: >
    php artisan user:create {{ abuseio_admin_username }} --password={{ abuseio_admin_password }}
  args:
    chdir: "{{ abuseio_home }}"
  when: abuseio_admin_username not in abuseio_user_list.stdout
  become: yes
  become_user: "{{ abuseio_user }}"

- name: Assign admin role to admin user if newly created
  command: >
    php artisan role:assign --role admin --user {{ abuseio_admin_username }}
  args:
    chdir: "{{ abuseio_home }}"
  when: abuseio_admin_username not in abuseio_user_list.stdout
  become: yes
  become_user: "{{ abuseio_user }}"

- name: Copy AbuseIO systemd unit files to /etc/systemd/system
  copy:
    src: "{{ abuseio_home }}/extra/etc/systemd/system/{{ item }}.service"
    dest: "/etc/systemd/system/{{ item }}.service"
    owner: root
    group: root
    mode: '0644'
    remote_src: yes
  loop:
    - abuseio_queue_collector
    - abuseio_queue_email_incoming
    - abuseio_queue_email_outgoing
    - abuseio_queue_delegation
  register: abuseio_units_copied
  changed_when: abuseio_units_copied is changed

- name: Reload systemd daemon after unit changes
  systemd:
    daemon_reload: yes
  when: abuseio_units_copied is changed

- name: Enable and start AbuseIO queue services
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: stopped
  loop:
    - abuseio_queue_collector
    - abuseio_queue_email_incoming
    - abuseio_queue_email_outgoing
    - abuseio_queue_delegation

- name: Enable and start AbuseIO queue services
  systemd:
    name: "{{ item }}"
    enabled: yes
    state: started
  loop:
    - abuseio_queue_collector
    - abuseio_queue_email_incoming
    - abuseio_queue_email_outgoing
    - abuseio_queue_delegation

- name: copy abuseio logrotate files
  copy:
    src: "{{ abuseio_home }}/extra/etc/logrotate.d/"
    dest: /etc/logrotate.d/

- name: copy abuseio syslog files
  copy:
    src: "{{ abuseio_home }}/extra/etc/rsyslog.d/"
    dest: /etc/rsyslog.d/

- name: restart syslog service 
  systemd:
    state: restarted
    daemon_reload: yes
    name: syslog