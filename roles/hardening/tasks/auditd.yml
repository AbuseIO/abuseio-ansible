---
# Configure a sane baseline of auditd rules

- name: Ensure auditd is installed
  apt:
    name: auditd
    state: present
    update_cache: yes

- name: Ensure auditd service is enabled and running
  service:
    name: auditd
    state: started
    enabled: yes

- name: Deploy baseline auditd rules
  copy:
    dest: /etc/audit/rules.d/hardening.rules
    owner: root
    group: root
    mode: '0644'
    content: |
      ## Identity files changes
      -w /etc/passwd -p wa -k identity
      -w /etc/group -p wa -k identity
      -w /etc/shadow -p wa -k identity
      -w /etc/gshadow -p wa -k identity

      ## Sudoers changes
      -w /etc/sudoers -p wa -k sudoers
      -w /etc/sudoers.d/ -p wa -k sudoers

      ## Auditd configuration changes
      -w /etc/audit/ -p wa -k auditconfig
      -w /etc/audit/audit.rules -p wa -k auditconfig

      ## Time modification events
      -a always,exit -F arch=b64 -S adjtimex,settimeofday,clock_settime -k time-change
      -a always,exit -F arch=b32 -S adjtimex,settimeofday,clock_settime -k time-change
      -w /etc/localtime -p wa -k time-change

      ## Session tracking
      -w /var/run/utmp -p wa -k session
      -w /var/log/wtmp -p wa -k session
      -w /var/log/btmp -p wa -k session

      ## Kernel module operations
      -w /sbin/insmod -p x -k modules
      -w /sbin/rmmod -p x -k modules
      -w /sbin/modprobe -p x -k modules

      ## AppArmor policy changes (Ubuntu)
      -w /etc/apparmor/ -p wa -k mac-policy

      ## Mount operations by users
      -a always,exit -F arch=b64 -S mount -F auid>=1000 -F auid!=4294967295 -k mounts
      -a always,exit -F arch=b32 -S mount -F auid>=1000 -F auid!=4294967295 -k mounts

      ## File deletions/renames by users
      -a always,exit -F arch=b64 -S unlink,unlinkat,rename,renameat -F auid>=1000 -F auid!=4294967295 -k delete
      -a always,exit -F arch=b32 -S unlink,unlinkat,rename,renameat -F auid>=1000 -F auid!=4294967295 -k delete
  notify: restart auditd

- name: Load auditd rules with augenrules
  command: augenrules --load
  register: augenrules_load
  changed_when: false