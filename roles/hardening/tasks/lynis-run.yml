---
- name: Ensure Lynis is installed
  apt:
    name: lynis
    state: present
    update_cache: yes

- name: Run Lynis system audit (async, long-running)
  command: lynis audit system --no-colors
  register: lynis_job
  async: 1800
  poll: 0

- name: Wait for Lynis audit to complete
  async_status:
    jid: "{{ lynis_job.ansible_job_id }}"
  register: lynis_result
  until: lynis_result.finished
  retries: 360
  delay: 5
