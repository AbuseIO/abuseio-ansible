---
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install needrestart for service restart handling
  apt:
    name: needrestart
    state: present

- name: Configure needrestart to automatic mode
  copy:
    dest: /etc/needrestart/conf.d/50-ansible.conf
    content: |
      $nrconf{restart} = 'a';
    owner: root
    group: root
    mode: '0644'

- name: Perform full dist-upgrade
  apt:
    upgrade: dist
  environment:
    DEBIAN_FRONTEND: noninteractive
    NEEDRESTART_MODE: a

- name: Add Ondrej PHP PPA
  apt_repository:
    repo: ppa:ondrej/php
    state: present

- name: Install base packages
  apt:
    name:
      - git
      - unzip
      - acl
    state: present

- name: Derive short hostname from FQDN
  set_fact:
    abuseio_short_hostname: "{{ (abuseio_hostname.split('.') | first) if ('.' in abuseio_hostname) else abuseio_hostname }}"

- name: Configure /etc/hostname with FQDN
  copy:
    dest: /etc/hostname
    content: "{{ abuseio_hostname }}\n"
    owner: root
    group: root
    mode: '0644'

- name: Apply hostname via hostnamectl
  command: hostnamectl set-hostname {{ abuseio_hostname }}
  register: hostnamectl_set
  changed_when: "(hostnamectl_set.rc | default(1)) == 0"
  failed_when: false

- name: Ensure 127.0.1.1 maps to short and FQDN in /etc/hosts
  lineinfile:
    path: /etc/hosts
    regexp: '^\s*127\.0\.1\.1\s+'
    line: '127.0.1.1 {{ abuseio_short_hostname }} {{ abuseio_hostname }}'
    create: yes
    backup: yes